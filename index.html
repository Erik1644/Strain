<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Strain - Strength Training App</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="Strain2.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
        </script>        
</head>

<body data-theme="dark">
  <!-- PROFILE BUTTON & MENU -->
  <button id="profile-btn" aria-label="Profile">üë§</button>

  <div id="profile-menu" class="profile-dropdown" aria-hidden="true">
      <button id="theme-btn">Change Theme</button>

      <!-- THEME SUBMENU (Option C) -->
      <div id="theme-submenu" class="profile-submenu" aria-hidden="true">
          <button class="theme-option" data-theme="dark">Dark</button>
          <button class="theme-option" data-theme="blue">Blue</button>
          <button class="theme-option" data-theme="orange">Orange</button>
      </div>

      <button onclick="exportWorkouts()">Backup / Export Data</button>
      <button onclick="resetData()">Reset All Data</button>
      <button onclick="linkProfile()">Link Profile</button>
  </div>

  <!-- MAIN APP CONTAINER -->
  <div class="container">
      <!-- HOME SCREEN -->
      <div id="home-screen" class="screen active">
          <h1>Your Strain</h1>

          <h2>Your Days</h2>
          <div id="days-list"></div>
          <button class="add-day-btn" onclick="addDay()">+ Add New Day</button>

          <div class="widgets-container">
              <div class="widget">
                  <h3>üèÜ Best Lifts</h3>
                  <div id="best-lifts-list"></div>
              </div>
              <div class="widget">
                  <h3>üìÖ Recent Workout</h3>
                  <div id="recent-workout"></div>
              </div>
          </div>
      </div>

      <!-- WORKOUT SCREEN -->
      <div id="workout-screen" class="screen">
          <h1 id="workout-title">Workout Logging</h1>
          <div id="exercises-log"></div>
          <div id="current-input-section"></div>
      </div>

      <!-- PROGRESS SCREEN -->
      <div id="progress-screen" class="screen">
          <h1>Progress & History</h1>
          <div style="height:140px; width:100%;">
              <canvas id="volumeChart"></canvas>
          </div>
          <div id="workout-history"></div>
      </div>
  </div>

  <!-- TAB NAV -->
  <div class="tab-nav">
      <button id="home-tab" class="active" onclick="switchScreen('home')">Home</button>
      <button id="workout-tab" onclick="switchScreen('workout')">Log</button>
      <button id="progress-tab" onclick="switchScreen('progress')">Progress</button>
  </div>

  <!-- SCRIPT: your app logic (reordered + wiring) -->
  <script>
  // ------------------------------
  // Data Structures (initial)
  // ------------------------------
  let appData = {
      days: [
          {
              id: 1,
              name: "Push Day",
              exercises: [
                  { name: "Bench Press" },
                  { name: "Overhead Press" }
              ]
          }
      ],
      currentWorkout: null,
      bestLifts: [],
      previousWorkouts: []
  };

  // ------------------------------
  // Persistence
  // ------------------------------
  function loadData() {
      const saved = localStorage.getItem('strainData');
      if (saved) {
          appData = JSON.parse(saved);
          if (!Array.isArray(appData.bestLifts)) appData.bestLifts = [];
          if (!Array.isArray(appData.previousWorkouts)) appData.previousWorkouts = [];
      }
  }

  function saveData() {
      localStorage.setItem('strainData', JSON.stringify(appData));
      console.log('Saved data:', appData);
  }

  loadData();

  // ------------------------------
  // Navigation
  // ------------------------------
  function switchScreen(screen) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab-nav button').forEach(b => b.classList.remove('active'));
      document.getElementById(`${screen}-screen`).classList.add('active');
      document.getElementById(`${screen}-tab`).classList.add('active');

      if (screen === 'home') renderHomeScreen();
      else if (screen === 'progress') renderProgress();
      else if (screen === 'workout') renderWorkoutScreen();
  }

  // ------------------------------
  // Home screen rendering
  // ------------------------------
  function renderHomeScreen() {
      console.log('Rendering home screen');
      renderDays();
      renderBestLifts();
      renderRecentWorkout();
  }

  function renderDays() {
      const list = document.getElementById('days-list');
      list.innerHTML = '';
      appData.days.forEach(day => {
          const card = document.createElement('div');
          card.className = 'day-card';
          card.innerHTML = `
              <h3>${day.name}</h3>
              ${day.exercises.map(ex => `<div class="exercise-item">${ex.name}</div>`).join('')}
              <button class="start-workout-btn" onclick="startWorkout(${day.id})">Start Workout</button>
              <button class="menu-btn" onclick="showMenu(${day.id}, event)">‚ãØ</button>
          `;
          list.appendChild(card);
      });
  }

  // ------------------------------
  // Best Lifts (DOM-based)
  // ------------------------------
  function renderBestLifts() {
    const container = document.getElementById('best-lifts-list');
    container.innerHTML = '';

    // No lifts yet
    if (!Array.isArray(appData.bestLifts) || appData.bestLifts.length === 0) {
        const noDataDiv = document.createElement('div');
        noDataDiv.className = 'no-data';
        noDataDiv.innerHTML = 'No best lifts recorded yet.<br>';
        container.appendChild(noDataDiv);

        const addBtn = document.createElement('button');
        addBtn.textContent = '+ Add Lift';
        addBtn.onclick = addBestLift;
        container.appendChild(addBtn); // Direct child so CSS applies
        return;
    }

    // Render existing best lifts
    appData.bestLifts.forEach((lift, index) => {
        const liftDiv = document.createElement('div');
        liftDiv.className = 'best-lift-item';

        // Exercise name and weight/reps
        const nameSpan = document.createElement('span');
        nameSpan.textContent = lift.exercise;
        const valueSpan = document.createElement('span');
        valueSpan.textContent = `${lift.weight}kg √ó ${lift.reps}`;
        liftDiv.appendChild(nameSpan);
        liftDiv.appendChild(valueSpan);

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => editBestLift(index);
        liftDiv.appendChild(editBtn);

        // Trash button
        const trashBtn = document.createElement('button');
        trashBtn.textContent = 'üóëÔ∏è';
        trashBtn.className = 'remove-best-lift-btn';
        trashBtn.onclick = () => removeBestLift(index);
        liftDiv.appendChild(trashBtn);

        container.appendChild(liftDiv);
    });

    // + Add Lift button if less than 3 lifts
    if (appData.bestLifts.length < 3) {
        const addBtn = document.createElement('button');
        addBtn.textContent = '+ Add Lift';
        addBtn.onclick = addBestLift;
        container.appendChild(addBtn); // Direct child so CSS applies
    }
}

  function addBestLift() {
      if (appData.bestLifts.length >= 3) {
          alert('You can only track up to 3 exercises for Best Lifts.');
          return;
      }

      const allExercises = getAllExercises();
      if (allExercises.length === 0) {
          alert('No exercises available. Add exercises to your days first.');
          return;
      }

      let message = 'Available exercises:\n';
      allExercises.forEach((exercise, index) => {
          message += `${index + 1}. ${exercise}\n`;
      });

      const exerciseName = prompt(`${message}\nEnter exercise name to track:`);

      if (exerciseName && allExercises.includes(exerciseName)) {
          if (appData.bestLifts.find(l => l.exercise === exerciseName)) {
              alert('You are already tracking this exercise!');
              return;
          }

          appData.bestLifts.push({ exercise: exerciseName, weight: 0, reps: 0 });
          renderHomeScreen();
          saveData();
      } else if (exerciseName) {
          alert('Exercise not found. Make sure you type the exact exercise name from your days.');
      }
  }

  function getAllExercises() {
      return [...new Set(appData.days.flatMap(day => day.exercises.map(ex => ex.name)))];
  }

  function renderRecentWorkout() {
      const container = document.getElementById('recent-workout');
      if (!appData.previousWorkouts || appData.previousWorkouts.length === 0) {
          container.innerHTML = '<div class="no-data">No workouts completed yet</div>';
          return;
      }
      const recent = appData.previousWorkouts[0];
      container.innerHTML = `
          <div class="recent-workout">
              <div><strong>${recent.type}</strong></div>
              <div class="recent-workout-date">${recent.date}</div>
              <div>${recent.volume}kg total volume</div>
          </div>
      `;
  }

  // ------------------------------
  // Home utilities (add/edit days)
  // ------------------------------
  function addDay() {
      const name = prompt('Enter day name:');
      if (name) {
          appData.days.push({
              id: Date.now(),
              name,
              exercises: []
          });
          renderHomeScreen();
          saveData();
      }
  }

  let activeMenu = null;
  let editMode = false;

  function showMenu(dayId, event) {
      event.stopPropagation();

      if (activeMenu) { activeMenu.remove(); activeMenu = null; }

      const menu = document.createElement('div');
      menu.className = 'menu-dropdown';
      menu.innerHTML = `
          <button onclick="toggleEditMode(${dayId})">Edit Day</button>
          <button onclick="deleteDay(${dayId})">Delete Day</button>
      `;
      event.target.parentElement.appendChild(menu);
      activeMenu = menu;
  }

  function toggleEditMode(dayId) {
      const day = appData.days.find(d => d.id === dayId);
      if (!day) return;
      editMode = !editMode;
      closeMenu();
      if (editMode) renderEditMode(day); else renderHomeScreen();
  }

  function renderEditMode(day) {
      const list = document.getElementById('days-list');
      list.innerHTML = '';
      const card = document.createElement('div');
      card.className = 'day-card';
      card.innerHTML = `
          <h3>
              ${day.name}
              <button class="edit-name-btn" onclick="editDayName(${day.id})">‚úèÔ∏è</button>
          </h3>
          <div id="exercises-edit-list"></div>
          <div class="edit-controls">
              <button class="add-exercise-btn" onclick="addExercise(${day.id})">+</button>
          </div>
          <button class="start-workout-btn" onclick="toggleEditMode(${day.id})">Done Editing</button>
      `;
      list.appendChild(card);
      renderExercisesEditList(day);
  }

  function renderExercisesEditList(day) {
      const list = document.getElementById('exercises-edit-list');
      list.innerHTML = '';
      day.exercises.forEach((exercise, index) => {
          const exerciseItem = document.createElement('div');
          exerciseItem.className = 'exercise-edit-item';
          exerciseItem.innerHTML = `
              <span>${exercise.name}</span>
              <button class="remove-exercise-btn" onclick="removeExercise(${day.id}, ${index})">-</button>
          `;
          list.appendChild(exerciseItem);
      });
  }

  function editDayName(dayId) {
      const day = appData.days.find(d => d.id === dayId);
      const newName = prompt('Edit day name:', day.name);
      if (newName) {
          day.name = newName;
          renderEditMode(day);
          saveData();
      }
  }

  function addExercise(dayId) {
      const day = appData.days.find(d => d.id === dayId);
      const exName = prompt('Exercise name:');
      if (exName) {
          day.exercises.push({ name: exName });
          renderExercisesEditList(day);
          saveData();
      }
  }

  function removeExercise(dayId, exerciseIndex) {
      const day = appData.days.find(d => d.id === dayId);
      day.exercises.splice(exerciseIndex, 1);
      renderExercisesEditList(day);
      saveData();
  }

  function deleteDay(dayId) {
      if (confirm('Delete this day?')) {
          appData.days = appData.days.filter(d => d.id !== dayId);
          renderHomeScreen();
          saveData();
      }
      closeMenu();
  }

  function closeMenu() {
      if (activeMenu) { activeMenu.remove(); activeMenu = null; }
  }
  document.addEventListener('click', closeMenu);

  // ------------------------------
  // Workout logging
  // ------------------------------
  let currentExerciseIndex = 0;

  function startWorkout(dayId) {
      const day = appData.days.find(d => d.id === dayId);
      if (!day || day.exercises.length === 0) { alert('This day has no exercises!'); return; }

      appData.currentWorkout = {
          date: new Date().toISOString().split('T')[0],
          dayId: day.id,
          dayName: day.name,
          exercises: day.exercises.map(ex => ({ name: ex.name, currentSets: [], previousWeek: getPreviousWeekData(day.name, ex.name) }))
      };
      currentExerciseIndex = 0;
      renderWorkoutScreen();
      switchScreen('workout');
  }

  function getPreviousWeekData(dayName, exerciseName) {
      const previousWorkout = appData.previousWorkouts.find(w => w.type === dayName && w.exercises && w.exercises.find(e => e.name === exerciseName));
      if (previousWorkout) {
          const previousExercise = previousWorkout.exercises.find(e => e.name === exerciseName);
          return previousExercise.currentSets || [];
      }
      return [];
  }

  function renderWorkoutScreen() {
      const workout = appData.currentWorkout;
      if (!workout) {
          document.getElementById('workout-title').textContent = "Workout Logging";
          document.getElementById('exercises-log').innerHTML = '<div class="no-data">No active workout. Start one from the Home tab!</div>';
          document.getElementById('current-input-section').innerHTML = '';
          // remove quick-add if present
          const q = document.getElementById('quick-add-btn'); if (q) q.remove();
          return;
      }
      document.getElementById('workout-title').textContent = workout.dayName;
      renderAllExercises();
      addQuickAddButton();
  }

  function renderAllExercises() {
      const container = document.getElementById('exercises-log');
      container.innerHTML = '';

      appData.currentWorkout.exercises.forEach((exercise, index) => {
          const exerciseDiv = document.createElement('div');
          exerciseDiv.className = `exercise-log ${index < currentExerciseIndex ? 'completed' : ''} ${index === currentExerciseIndex ? 'current' : ''}`;
          exerciseDiv.innerHTML = `
              <h3>${exercise.name}</h3>
              ${exercise.currentSets.map((set, setIndex) => `<p>Set ${setIndex + 1}: ${set.weight}kg x ${set.reps}</p>`).join('')}
              ${exercise.currentSets.length === 0 ? '<p>No sets logged yet</p>' : ''}
          `;
          container.appendChild(exerciseDiv);

          if (index === currentExerciseIndex) {
              const inputSection = document.createElement('div');
              inputSection.className = 'current-exercise-input';
              inputSection.innerHTML = renderCurrentInputSection(index);
              container.appendChild(inputSection);
          }
      });
  }

  function renderCurrentInputSection(index) {
      const workout = appData.currentWorkout;
      if (!workout || index >= workout.exercises.length) {
          return `<button class="add-set-btn" onclick="finishWorkout()">Finish Workout</button>`;
      }

      const currentExercise = workout.exercises[index];
      const nextSetNumber = currentExercise.currentSets.length + 1;
      const previousSet = currentExercise.previousWeek[nextSetNumber - 1];
      const suggested = getSuggestedSet(currentExercise.name, nextSetNumber);

      const weightId = `weight-${index}`;
      const repsId = `reps-${index}`;

      return `
          ${previousSet ? `<div class="previous-week-hint">Last ${workout.dayName}: Set ${nextSetNumber} - ${previousSet.weight}kg x ${previousSet.reps}</div>` : ''}
          <div class="set-input">
              <input type="number" id="${weightId}" placeholder="Weight (kg)" value="${suggested.weight || (previousSet ? previousSet.weight : '')}">
              <input type="number" id="${repsId}" placeholder="Reps" value="${suggested.reps || (previousSet ? previousSet.reps : '')}">
          </div>
          <div>
            <button class="add-set-btn" onclick="addSet(${index})">Log Set ${nextSetNumber}</button>
            <button class="add-set-btn" onclick="undoLastSet()">Undo Last Set</button>
            ${index < workout.exercises.length - 1 ? '<button class="add-set-btn" onclick="nextExercise()">Next Exercise</button>' : '<button class="add-set-btn" onclick="finishWorkout()">Finish Workout</button>'}
          </div>
      `;
  }

  function getSuggestedSet(exerciseName, setNumber) {
      if (!appData.previousWorkouts || !appData.previousWorkouts.length) return { weight: '', reps: '' };
      const prevWorkout = appData.previousWorkouts.find(w => w.exercises && w.exercises.some(e => e.name === exerciseName));
      if (!prevWorkout) return { weight: '', reps: '' };
      const prevExercise = prevWorkout.exercises.find(e => e.name === exerciseName);
      if (!prevExercise || !prevExercise.currentSets[setNumber - 1]) return { weight: '', reps: '' };
      return prevExercise.currentSets[setNumber - 1];
  }

  function undoLastSet() {
      if (!appData.currentWorkout) return;
      const exercise = appData.currentWorkout.exercises[currentExerciseIndex];
      if (exercise.currentSets.length > 0) {
          exercise.currentSets.pop();
          renderWorkoutScreen();
          saveData();
      } else {
          alert("No sets to undo!");
      }
  }

  function addSet(index) {
      if (!appData.currentWorkout) { alert('No active workout.'); return; }

      const weightInput = document.getElementById(`weight-${index}`);
      const repsInput = document.getElementById(`reps-${index}`);
      if (!weightInput || !repsInput) { alert('Inputs missing.'); return; }

      const weight = parseFloat(weightInput.value);
      const reps = parseInt(repsInput.value, 10);
      if (isNaN(weight) || weight <= 0 || isNaN(reps) || reps <= 0) {
          alert('Please enter valid positive numbers for weight and reps.');
          return;
      }

      const exercise = appData.currentWorkout.exercises[index];
      exercise.currentSets.push({ weight, reps });

      updateBestLifts(exercise.name, weight, reps);
      saveData();

      const exercisesContainer = document.getElementById('exercises-log');
      const exerciseDivs = exercisesContainer.getElementsByClassName('exercise-log');
      const exerciseDiv = exerciseDivs[index];

      if (exerciseDiv) {
          exerciseDiv.innerHTML = `<h3>${exercise.name}</h3>` + exercise.currentSets.map((set, i) => `<p>Set ${i + 1}: ${set.weight}kg x ${set.reps}</p>`).join('');
          const oldInput = document.querySelector('.current-exercise-input'); if (oldInput) oldInput.remove();
          const inputSection = document.createElement('div');
          inputSection.className = 'current-exercise-input';
          inputSection.innerHTML = renderCurrentInputSection(index);
          exerciseDiv.parentNode.insertBefore(inputSection, exerciseDiv.nextSibling);
      }

      const nextWeight = document.getElementById(`weight-${index}`); if (nextWeight) nextWeight.focus();
  }

  function updateBestLifts(exerciseName, weight, reps) {
      if (!Array.isArray(appData.bestLifts)) appData.bestLifts = [];
      const bestLift = appData.bestLifts.find(l => l.exercise === exerciseName);
      if (!bestLift) return;
      if (weight > bestLift.weight || (weight === bestLift.weight && reps > bestLift.reps)) {
          bestLift.weight = weight; bestLift.reps = reps;
      }
  }

  function nextExercise() { currentExerciseIndex++; renderWorkoutScreen(); }

  function addQuickAddButton() {
      const existing = document.getElementById('quick-add-btn'); if (existing) existing.remove();
      const btn = document.createElement('button');
      btn.id = 'quick-add-btn'; btn.textContent = 'Ôºã';
      btn.onclick = () => {
          const name = prompt('Enter exercise name:');
          if (name && appData.currentWorkout) {
              appData.currentWorkout.exercises.push({ name, currentSets: [], previousWeek: [] });
              renderWorkoutScreen();
          }
      };
      document.body.appendChild(btn);
  }

  function finishWorkout() {
      const workout = appData.currentWorkout;
      const totalVolume = calculateTotalVolume(workout);
      appData.previousWorkouts.unshift({ date: workout.date, type: workout.dayName, volume: totalVolume, exercises: workout.exercises });
      appData.currentWorkout = null; currentExerciseIndex = 0; saveData();
      switchScreen('home');
  }

  function calculateTotalVolume(workout) {
      return workout.exercises.reduce((total, ex) => total + ex.currentSets.reduce((exTotal, set) => exTotal + (set.weight * set.reps), 0), 0);
  }

  // ------------------------------
  // Chart / Progress
  // ------------------------------
  function renderVolumeChart() {
      const ctx = document.getElementById('volumeChart').getContext('2d');
      const sortedWorkouts = [...appData.previousWorkouts].sort((a,b) => new Date(a.date) - new Date(b.date));
      const labels = sortedWorkouts.map(w => w.date);
      const data = sortedWorkouts.map(w => w.volume);
      if (window.volumeChartInstance) window.volumeChartInstance.destroy();
      window.volumeChartInstance = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Total Workout Volume (kg)', data, borderColor: '#007AFF', backgroundColor: 'rgba(0,122,255,0.18)', fill:true, tension:0.3, pointRadius:4 }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
  }

  function renderProgress() {
      const historyContainer = document.getElementById('workout-history');
      historyContainer.innerHTML = '';
      if (!appData.previousWorkouts || appData.previousWorkouts.length === 0) {
          const noDataDiv = document.createElement('div'); noDataDiv.className='no-data'; noDataDiv.textContent='No workout history yet'; historyContainer.appendChild(noDataDiv); return;
      }
      appData.previousWorkouts.forEach(workout => {
          const card = document.createElement('div'); card.className = 'progress-card';
          card.innerHTML = `<h3>${workout.type}</h3><p><strong>Date:</strong> ${workout.date}</p><p><strong>Total Volume:</strong> ${workout.volume} kg</p><p><strong>Exercises:</strong> ${(workout.exercises||[]).map(e=>e.name).join(', ')}</p>`;
          historyContainer.appendChild(card);
      });
      renderVolumeChart();
  }

  // ------------------------------
  // Export / profile / theme / reset
  // ------------------------------
  function exportWorkouts() {
      const dataStr = JSON.stringify(appData.previousWorkouts, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `workouts_backup_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
  }

  function changeTheme() {
      // Keep your original prompt-based changeTheme as a manual fallback
      const newBg = prompt("Enter background color (hex or name):", "#121212");
      const newAccent = prompt("Enter accent color (hex):", "#007AFF");
      if (newBg && newAccent) {
          document.body.style.backgroundColor = newBg;
          document.documentElement.style.setProperty('--accent-color', newAccent);
          alert("Theme changed! Refresh if needed.");
      }
  }

  function resetData() {
      if (confirm("Are you sure? This will erase ALL data!")) {
          localStorage.removeItem('strainData');
          location.reload();
      }
  }

  function linkProfile() {
      const profileName = prompt("Enter profile name:");
      if (profileName) {
          localStorage.setItem('strainProfile', profileName);
          alert("Profile saved locally. (Future: sync to cloud)");
      }
  }

  // ------------------------------
  // Initialization
  // ------------------------------
  renderHomeScreen();
  renderProgress();

  // Load saved theme or default
  document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');

  // ------------------------------
  // THEME SUBMENU / PROFILE MENU WIRING
  // ------------------------------
  (function setupProfileAndTheme() {
      const profileBtn = document.getElementById('profile-btn');
      const profileMenu = document.getElementById('profile-menu');
      const themeBtn = document.getElementById('theme-btn');
      const themeSubmenu = document.getElementById('theme-submenu');

      profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block'; });

      // toggle theme submenu inside profile menu
      themeBtn.addEventListener('click', (e) => { e.stopPropagation(); themeSubmenu.style.display = themeSubmenu.style.display === 'block' ? 'none' : 'block'; });

      // theme option clicks
      document.querySelectorAll('.theme-option').forEach(btn => {
          btn.addEventListener('click', () => {
              const theme = btn.dataset.theme;
              document.body.setAttribute('data-theme', theme);
              localStorage.setItem('theme', theme);
              // close menus
              themeSubmenu.style.display = 'none';
              profileMenu.style.display = 'none';
          });
      });

      // close menu if clicked outside
      document.addEventListener('click', () => { profileMenu.style.display = 'none'; themeSubmenu.style.display = 'none'; });
  })();
  </script>
</body>
</html>